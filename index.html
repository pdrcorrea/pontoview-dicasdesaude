<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PontoView • Dicas de Saúde</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;600;800;900&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,650,0,0" />

  <style>
    :root{
      --ink:#0b1626;

      --topA:#0b2a44;
      --topB:#2c6aa3;
      --topC:#0f3d63;

      --pad: clamp(14px, 1.8vw, 26px);
      --gap: clamp(12px, 1.4vw, 18px);

      --panel:#e7edf5;
      --card: rgba(255,255,255,.78);
      --line: rgba(210,222,238,.95);

      --radius: clamp(24px, 2.2vw, 36px);
      --footerH: clamp(54px, 6vh, 78px);

      --ease: cubic-bezier(.2,.8,.2,1);
      --anim: 520ms;

      --dividerGrad: linear-gradient(90deg,
        rgba(44,106,163,0) 0%,
        rgba(44,106,163,.9) 18%,
        rgba(15,61,99,.95) 50%,
        rgba(44,106,163,.9) 82%,
        rgba(44,106,163,0) 100%
      );

      --bad:#ef4444;
      --badBg: rgba(239,68,68,.12);
      --badLine: rgba(239,68,68,.24);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--ink);
      background:#fff;
      overflow:hidden;
    }

    .pvShell{
      width:100vw; height:100vh;
      display:flex; flex-direction:column;
      min-height:0;
      background:#fff;
    }

    /* ================= HEADER ================= */
    .pvHeader{
      position:relative;
      background: linear-gradient(180deg, var(--topB) 0%, var(--topC) 42%, var(--topA) 100%);
      color:#fff;
      padding: clamp(14px, 1.8vw, 22px) var(--pad);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:var(--gap);
      flex:0 0 auto;
      min-width:0;
      border-bottom: 1px solid rgba(255,255,255,.12);
      box-shadow: inset 0 -1px 0 rgba(255,255,255,.18);
    }
    .pvHeader::before{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background:
        radial-gradient(900px 120px at 50% 0%, rgba(255,255,255,.22), rgba(255,255,255,0) 65%),
        linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,0) 42%);
      opacity:.95;
    }

    .pvHeaderLeft, .pvHeaderRight{position:relative; z-index:1;}
    .pvHeaderLeft{
      display:flex; align-items:center;
      gap: clamp(12px, 1.5vw, 18px);
      min-width:0;
      flex:1 1 auto;
    }

    .pvIconBadge{
      width: clamp(44px, 4.2vw, 64px);
      height: clamp(44px, 4.2vw, 64px);
      border-radius: 18px;
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.24);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.20), 0 14px 28px rgba(0,0,0,.14);
      backdrop-filter: blur(10px);
      display:grid; place-items:center;
      flex:0 0 auto;
      color:#fff;
    }
    .pvIconBadge .material-symbols-outlined{
      font-size: 34px;
      line-height: 1;
      color:#fff;
      opacity:.98;
      font-variation-settings:'FILL' 0,'wght' 650,'GRAD' 0,'opsz' 24;
    }

    .pvTitles{display:flex; flex-direction:column; gap:6px; min-width:0;}
    .pvTitle{
      margin:0;
      font-size: clamp(18px, 2.1vw, 34px);
      font-weight:900;
      letter-spacing:.06em;
      text-transform:uppercase;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      line-height:1.02;
    }

    /* header right vazio */
    .pvHeaderRight{min-width: clamp(8px, 8vw, 140px);}

    /* ================= MAIN ================= */
    .pvMain{
      flex:1 1 auto;
      min-height:0;
      padding: var(--pad);
      display:flex;
      overflow:hidden;
      background:#fff;
    }

    .panel{
      width:100%;
      min-height:0;
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(231,237,245,1), rgba(223,232,244,1));
      padding: clamp(12px, 1.4vw, 18px);
      overflow:hidden;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.45);
      display:flex;
    }

    .card{
      width:100%;
      border-radius: var(--radius);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
      background: var(--card);
      border: 1px solid var(--line);
      box-shadow: 0 12px 26px rgba(2,10,23,.10);
      backdrop-filter: blur(7px);
      position:relative;
    }

    .cardHeader{
      padding: clamp(16px, 1.8vw, 22px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex:0 0 auto;
      min-width:0;
    }
    .cardHeader .label{
      font-size: 12px;
      font-weight: 900;
      letter-spacing:.14em;
      text-transform: uppercase;
      color:#3b4b62;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      opacity:.95;
    }
    .toggleDots{display:flex; gap:8px; align-items:center;}
    .tdot{
      width:10px; height:10px; border-radius:999px;
      background:#c9d7ea;
      transition: all 420ms var(--ease);
    }
    .tdot.active{background:#2d76b9; width:22px;}

    /* Layout: texto grande + rodapé compacto */
    .content{
      flex:1 1 auto;
      min-height:0;
      padding: clamp(18px, 2.2vw, 30px);
      display:grid;
      grid-template-rows: 1fr auto; /* manchete manda */
      gap: clamp(12px, 1.6vw, 18px);
      overflow:hidden;
    }

    .tipArea{
      min-height:0;
      display:flex;
      flex-direction:column;
      gap: 12px;
      overflow:hidden;
    }

    .tipKicker{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.86);
      border:1px solid rgba(210,222,238,.95);
      box-shadow: 0 10px 22px rgba(0,0,0,.05);
      width: fit-content;
      max-width: 100%;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-size: 12px;
      font-weight: 900;
      letter-spacing:.10em;
      text-transform: uppercase;
      color:#23344a;
      flex:0 0 auto;
    }
    .tipKicker .material-symbols-outlined{
      font-size: 18px;
      opacity:.9;
      font-variation-settings:'FILL' 0,'wght' 650,'GRAD' 0,'opsz' 24;
    }

    /* Manchete: auto-fit via JS */
    .tipTitle{
      margin:0;
      font-weight: 900;
      letter-spacing: -0.02em;
      line-height: 1.10;
      color: var(--ink);
      text-wrap: balance;
      overflow: visible;
      flex:0 0 auto;
    }

    .tipBody{
      margin:0;
      font-weight: 800;
      color: rgba(11,19,32,.58);
      line-height: 1.45;
      max-width: 74ch;
      text-wrap: pretty;
      overflow:hidden;
      display:none;
      flex:0 0 auto;
    }

    /* ====== bottom: imagem + qr lado a lado ====== */
    .bottomRow{
      display:grid;
      grid-template-columns: 1fr auto; /* imagem cresce, QR fixo */
      gap: 12px;
      align-items:stretch;
      min-height:0;
    }

    /* Imagem (aparece somente se tiver url válida) */
    .miniMedia{
      display:none;
      height: clamp(104px, 16vh, 150px);
      border-radius: 18px;
      overflow:hidden;
      background: linear-gradient(180deg, rgba(44,106,163,.24), rgba(15,61,99,.18));
      border: 1px solid rgba(210,222,238,.95);
      box-shadow: 0 12px 28px rgba(2,10,23,.10);
      position:relative;
      min-width:0;
    }
    .miniMedia img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      opacity: .98;
      transform: scale(1.02);
    }
    .miniMedia::after{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,.06), rgba(0,0,0,.18));
      pointer-events:none;
    }

    /* QR pequeno */
    .qrBox{
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap: 12px;
      padding: 12px 12px;
      border-radius: 18px;
      background: rgba(255,255,255,.66);
      border: 1px solid rgba(210,222,238,.95);
      box-shadow: 0 14px 34px rgba(2,10,23,.10);
      overflow:hidden;
      min-width: 270px;
    }
    .qrImg{
      width: 88px;
      height: 88px;
      border-radius: 16px;
      background:#fff;
      border:1px solid rgba(210,222,238,.95);
      box-shadow: 0 10px 24px rgba(2,10,23,.08);
      display:block;
      flex:0 0 auto;
    }
    .qrText{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap: 6px;
    }
    .qrTitle{
      margin:0;
      font-size: 12px;
      font-weight: 900;
      letter-spacing:.12em;
      text-transform: uppercase;
      color:#23344a;
      opacity:.90;
      line-height:1.1;
    }
    .qrHost{
      margin:0;
      font-size: 11px;
      font-weight: 900;
      letter-spacing:.10em;
      text-transform: uppercase;
      color:#3b4b62;
      opacity:.78;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 26ch;
      line-height:1.1;
    }
    .qrHint{
      margin:0;
      font-size: 12px;
      font-weight: 800;
      color:#5a6b82;
      line-height:1.35;
      opacity:.85;
      display:-webkit-box;
      -webkit-box-orient:vertical;
      -webkit-line-clamp:2;
      overflow:hidden;
      max-width: 38ch;
    }
    .qrBox.is-hidden{display:none}

    /* Troca suave */
    .pvFadeOut .tipKicker,
    .pvFadeOut .tipTitle,
    .pvFadeOut .tipBody,
    .pvFadeOut .bottomRow{
      opacity:0;
      transform: translateY(8px);
      filter: blur(1px);
    }
    .tipKicker,.tipTitle,.tipBody,.bottomRow{
      transition: opacity var(--anim) ease, transform var(--anim) ease, filter var(--anim) ease;
    }

    /* progress acima do rodapé */
    .progressWrap{
      flex:0 0 auto;
      padding: 0 var(--pad);
      background:#fff;
    }
    .divider{
      height: 4px;
      border-radius: 999px;
      background: var(--dividerGrad);
      position:relative;
      overflow:hidden;
    }
    #cycleFill{
      position:absolute;
      inset:0;
      width:0%;
      background: linear-gradient(90deg, rgba(255,255,255,.16), rgba(255,255,255,.38));
      mix-blend-mode: screen;
      border-radius: 999px;
      transition: width 120ms linear;
      transform-origin:left center;
    }

    /* footer */
    .pvFooter{
      flex:0 0 auto;
      height: var(--footerH);
      display:flex;
      align-items:center;
      justify-content:flex-end;
      padding: 10px var(--pad);
      background:#fff;
      min-width:0;
    }
    .pvLogo{
      height: clamp(16px, 2.3vh, 22px);
      width:auto;
      display:block;
      opacity:.92;
    }

    /* OFFLINE overlay */
    .pvOffline{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: var(--pad);
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index: 5;
    }
    .pvOfflineCard{
      width: min(980px, 92%);
      border-radius: 20px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.86);
      box-shadow: 0 14px 40px rgba(0,0,0,.10);
      padding: clamp(18px, 2.2vw, 30px);
      display:flex;
      gap: 18px;
      align-items:flex-start;
      backdrop-filter: blur(8px);
    }
    .pvOfflineIcon{
      width: 54px; height: 54px;
      border-radius: 16px;
      background: var(--badBg);
      border:1px solid var(--badLine);
      display:grid;
      place-items:center;
      flex:0 0 auto;
      color: var(--bad);
    }
    .pvOfflineIcon .material-symbols-outlined{
      font-size: 28px;
      opacity:.95;
      font-variation-settings:'FILL' 0,'wght' 650,'GRAD' 0,'opsz' 24;
    }
    .pvOfflineTitle{
      margin:0;
      font-weight: 900;
      letter-spacing:.08em;
      text-transform: uppercase;
      font-size: clamp(16px, 1.6vw, 22px);
      color:#0f172a;
    }
    .pvOfflineText{
      margin:10px 0 0;
      color:#334155;
      font-weight:800;
      font-size: clamp(14px, 1.5vw, 18px);
      line-height:1.35;
      opacity:.92;
    }
    .pvOfflineHint{
      margin:10px 0 0;
      color:#475569;
      font-weight:900;
      font-size: clamp(12px, 1.2vw, 14px);
      letter-spacing:.08em;
      text-transform: uppercase;
      opacity:.75;
    }

    @media (orientation: portrait){
      .miniMedia{ height: clamp(96px, 14vh, 150px); }
      .qrHint{ -webkit-line-clamp: 3; }
      .qrBox{ min-width: 250px; }
    }

    @media (max-height: 620px){
      .bottomRow{ display:none; }
    }

    @media (prefers-reduced-motion: reduce){
      .tipKicker,.tipTitle,.tipBody,.bottomRow{ transition:none; }
      #cycleFill{ transition:none !important; }
    }
  </style>
</head>

<body>
  <div class="pvShell" id="panel" data-title="DICAS DE SAÚDE">
    <header class="pvHeader">
      <div class="pvHeaderLeft">
        <div class="pvIconBadge" aria-hidden="true">
          <span class="material-symbols-outlined">health_and_safety</span>
        </div>
        <div class="pvTitles">
          <h1 class="pvTitle" id="titleHdr"></h1>
        </div>
      </div>
      <div class="pvHeaderRight" aria-hidden="true"></div>
    </header>

    <main class="pvMain">
      <div class="panel">
        <section class="card" id="card">
          <div class="cardHeader">
            <div class="label" id="kickerSmall">BEM-ESTAR • SERVIÇO</div>
            <div class="toggleDots" aria-hidden="true">
              <div class="tdot active" id="dotA"></div>
              <div class="tdot" id="dotB"></div>
            </div>
          </div>

          <div class="content" id="stage">
            <div class="tipArea" id="tipArea">
              <div class="tipKicker" id="tipKicker">
                <span class="material-symbols-outlined" id="tipIcon">info</span>
                <span id="tipCat">SAÚDE</span>
              </div>

              <h2 class="tipTitle" id="tipTitle">Carregando…</h2>
              <p class="tipBody" id="tipBody"></p>
            </div>

            <!-- Imagem + QR lado a lado (sem roubar o espaço da manchete) -->
            <div class="bottomRow">
              <div class="miniMedia" id="miniMedia" aria-label="Imagem ilustrativa">
                <img id="miniImg" alt="">
              </div>

              <div class="qrBox is-hidden" id="qrBox" aria-label="QR Code para ler mais">
                <img class="qrImg" id="qrImg" alt="QR Code">
                <div class="qrText">
                  <p class="qrTitle">LEIA MAIS</p>
                  <p class="qrHost" id="qrHost">—</p>
                  <p class="qrHint" id="qrHint"></p>
                </div>
              </div>
            </div>
          </div>

          <div class="pvOffline" id="offlineLayer" aria-hidden="true">
            <div class="pvOfflineCard" role="status" aria-label="Modo offline">
              <div class="pvOfflineIcon" aria-hidden="true">
                <span class="material-symbols-outlined">wifi_off</span>
              </div>
              <div>
                <p class="pvOfflineTitle">MODO OFFLINE</p>
                <p class="pvOfflineText">
                  Sem conexão com a internet no momento. O painel continua exibindo conteúdos locais e se atualiza quando a conexão voltar.
                </p>
                <p class="pvOfflineHint">verificando conexão…</p>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>

    <div class="progressWrap" aria-hidden="true">
      <div class="divider"><div id="cycleFill"></div></div>
    </div>

    <footer class="pvFooter" aria-label="Rodapé">
      <img class="pvLogo" src="assets/logo-pontoview.png" alt="PontoView" onerror="this.style.display='none'">
    </footer>
  </div>

  <script>
    /***********************
     * CONFIG
     ***********************/
    const WORKER_URL = "https://saude.pedrhc258.workers.dev/api/health-tips";
    const ROTATE_MS = 16000;
    const TRANSITION_MS = 520;
    const FETCH_EVERY_MIN = 30;

    function qrUrl(link){
      if(!link) return "";
      return "https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=" + encodeURIComponent(link);
    }
    function hostFromLink(link){
      try{ return new URL(link).hostname.replace(/^www\./,""); } catch { return ""; }
    }

    /***********************
     * IMAGENS (adicione aqui os caminhos reais)
     * IMPORTANTE: se estiver usando pasta assets, use caminhos relativos corretos:
     * - "assets/saude/01.webp"  (sem barra inicial)
     * - ou URL completa https://...
     ***********************/
    const LOCAL_IMAGES = [
      // "assets/saude/01.webp",
      // "assets/saude/02.webp",
      // "assets/saude/03.webp",
    ];

    /***********************
     * CONTEÚDO LOCAL
     ***********************/
    const LOCAL_ITEMS = [
      {
        category:"Hidratação",
        icon:"water_drop",
        text:"Hidrate-se ao longo do dia — pequenos goles com frequência ajudam a manter o hábito.",
        hint:"Dica prática: deixe uma garrafa à vista e água acessível.",
        source:"PontoView",
        sourceDomain:"pontoview",
        link:"https://www.gov.br/saude/pt-br/assuntos/saude-brasil/eu-quero-me-alimentar-melhor/noticias/2021/nao-consegue-beber-agua-suficiente-confira-5-dicas-para-aumentar-a-sua-hidratacao",
        image:"" // opcional: "assets/saude/01.webp"
      },
      {
        category:"Bem-estar",
        icon:"self_improvement",
        text:"Pausa rápida: respire fundo por 20 segundos, inspire pelo nariz e solte devagar.",
        hint:"Uma pausa curta já melhora o conforto.",
        source:"PontoView",
        sourceDomain:"pontoview",
        link:"https://www.gov.br/saude/pt-br",
        image:""
      },
      {
        category:"Movimento",
        icon:"directions_walk",
        text:"Se estiver sentado há muito tempo, levante e caminhe um pouco. Movimentos curtos ao longo do dia fazem diferença.",
        hint:"Alongue ombros e pescoço por 30–60s.",
        source:"PontoView",
        sourceDomain:"pontoview",
        link:"https://www.gov.br/saude/pt-br",
        image:""
      },
      {
        category:"Higiene",
        icon:"wash",
        text:"Higienize as mãos: palmas, dorso, dedos e unhas. É uma das medidas mais eficazes no dia a dia.",
        hint:"Sempre que possível, use água e sabão.",
        source:"PontoView",
        sourceDomain:"pontoview",
        link:"https://www.gov.br/anvisa/pt-br",
        image:""
      },
      {
        category:"Telas",
        icon:"visibility",
        text:"Pausa de tela: descanse os olhos olhando para um ponto distante por alguns segundos.",
        hint:"Mudanças simples ajudam no conforto.",
        source:"PontoView",
        sourceDomain:"pontoview",
        link:"https://www.gov.br/saude/pt-br",
        image:""
      }
    ];

    /***********************
     * ELEMENTOS
     ***********************/
    document.getElementById("titleHdr").textContent =
      document.getElementById("panel").dataset.title || "DICAS DE SAÚDE";

    const stage = document.getElementById("stage");
    const tipArea = document.getElementById("tipArea");
    const tipIcon = document.getElementById("tipIcon");
    const tipCat  = document.getElementById("tipCat");
    const tipTitle= document.getElementById("tipTitle");
    const tipBody = document.getElementById("tipBody");
    const kickerSmall = document.getElementById("kickerSmall");

    const qrBox = document.getElementById("qrBox");
    const qrImg = document.getElementById("qrImg");
    const qrHost = document.getElementById("qrHost");
    const qrHint = document.getElementById("qrHint");

    const miniMedia = document.getElementById("miniMedia");
    const miniImg = document.getElementById("miniImg");

    const offlineLayer = document.getElementById("offlineLayer");

    const dotA = document.getElementById("dotA");
    const dotB = document.getElementById("dotB");
    const cycleFill = document.getElementById("cycleFill");

    /***********************
     * STATE
     ***********************/
    let remoteItems = [];
    let playlist = [];
    let idx = 0;
    let rotStart = performance.now();
    let imgIdx = 0;

    /***********************
     * UTIL
     ***********************/
    function cleanText(s){
      return String(s || "").replace(/\s+/g," ").trim();
    }
    function safeItem(it){
      if(!it) return null;
      const text = cleanText(it.text);
      if(!text) return null;
      return {
        text,
        source: cleanText(it.source || "Fonte"),
        sourceDomain: cleanText(it.sourceDomain || hostFromLink(it.link) || ""),
        link: String(it.link || "").trim(),
        icon: cleanText(it.icon || "info"),
        lang: cleanText(it.lang || "pt-BR"),
        category: cleanText(it.category || "Saúde"),
        hint: cleanText(it.hint || ""),
        image: String(it.image || "").trim()
      };
    }
    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }
    function dedupe(items){
      const seen = new Set();
      const out = [];
      for(const it of items){
        const key = `${(it.link||"")}|${it.text}`.toLowerCase();
        if(seen.has(key)) continue;
        seen.add(key);
        out.push(it);
      }
      return out;
    }
    function interleave(a, b){
      const out = [];
      const A = a.slice(), B = b.slice();
      let i=0;
      while(i < A.length || i < B.length){
        if(i < A.length) out.push(A[i]);
        if(i < B.length) out.push(B[i]);
        i++;
      }
      return out;
    }

    /***********************
     * AUTO-FIT DO TÍTULO
     ***********************/
    function fitTitle(){
      const max = Math.round(Math.min(70, window.innerWidth * 0.06));
      const min = 22;

      tipTitle.style.fontSize = max + "px";
      const containerH = tipArea.clientHeight;
      if(containerH <= 0) return;

      let lo = min, hi = max, best = min;

      for(let k=0; k<10; k++){
        const mid = Math.floor((lo+hi)/2);
        tipTitle.style.fontSize = mid + "px";
        tipTitle.offsetHeight;

        const used = tipArea.scrollHeight;
        if(used <= containerH){
          best = mid;
          lo = mid + 1;
        }else{
          hi = mid - 1;
        }
      }
      tipTitle.style.fontSize = best + "px";
    }

    /***********************
     * UI
     ***********************/
    function flipDots(){
      const aActive = dotA.classList.contains("active");
      dotA.classList.toggle("active", !aActive);
      dotB.classList.toggle("active", aActive);
    }

    function setOfflineOverlay(){
      const isOnline = navigator.onLine;
      offlineLayer.style.display = isOnline ? "none" : "flex";
      offlineLayer.setAttribute("aria-hidden", isOnline ? "true" : "false");
    }

    function applyKicker(cat){
      tipCat.textContent = (cat || "SAÚDE").toUpperCase();
      kickerSmall.textContent = "BEM-ESTAR • SERVIÇO";
    }

    function pickFallbackImage(){
      if(!LOCAL_IMAGES.length) return "";
      const img = LOCAL_IMAGES[imgIdx++ % LOCAL_IMAGES.length];
      return img || "";
    }

    function setMiniImage(imageUrl){
      const url = String(imageUrl || "").trim();
      if(!url){
        miniMedia.style.display = "none";
        miniImg.removeAttribute("src");
        miniImg.onerror = null;
        return;
      }
      miniMedia.style.display = "block";
      miniImg.src = url;

      miniImg.onerror = () => {
        const fb = pickFallbackImage();
        if(fb && fb !== url){
          miniImg.src = fb;
        }else{
          miniMedia.style.display = "none";
          miniImg.removeAttribute("src");
        }
        miniImg.onerror = null;
      };
    }

    function render(it){
      const item = safeItem(it) || safeItem(LOCAL_ITEMS[0]);
      if(!item) return;

      tipIcon.textContent = item.icon || "info";
      applyKicker(item.category);

      tipTitle.textContent = item.text;

      if(item.hint){
        tipBody.style.display = "";
        tipBody.textContent = item.hint;
      }else{
        tipBody.style.display = "none";
        tipBody.textContent = "";
      }

      // Imagem: usa item.image; senão, carrossel LOCAL_IMAGES
      const img = item.image || pickFallbackImage();
      setMiniImage(img);

      // QR
      if(item.link){
        const h = hostFromLink(item.link) || item.sourceDomain || "LINK";
        qrHost.textContent = (h || "LINK").toUpperCase();
        qrHint.textContent = item.hint ? item.hint : "Aponte a câmera para acessar a fonte.";
        qrImg.src = qrUrl(item.link);
        qrBox.classList.remove("is-hidden");

        qrImg.onerror = () => {
          qrBox.classList.add("is-hidden");
          qrImg.removeAttribute("src");
          qrImg.onerror = null;
        };
      }else{
        qrBox.classList.add("is-hidden");
        qrImg.removeAttribute("src");
        qrImg.onerror = null;
      }

      requestAnimationFrame(() => fitTitle());
    }

    /***********************
     * ROTATION + PROGRESS
     ***********************/
    function animateProgress(now){
      const p = ((now - rotStart) % ROTATE_MS) / ROTATE_MS;
      cycleFill.style.width = `${Math.max(2, p*100)}%`;
      requestAnimationFrame(animateProgress);
    }

    function step(){
      if(!playlist.length) return;
      stage.classList.add("pvFadeOut");
      setTimeout(()=>{
        flipDots();
        render(playlist[idx++ % playlist.length]);
        stage.classList.remove("pvFadeOut");
        rotStart = performance.now();
      }, TRANSITION_MS);
    }

    /***********************
     * DATA: worker + local, intercalado
     ***********************/
    async function fetchJsonWithTimeout(url, ms=9000){
      const ctl = new AbortController();
      const t = setTimeout(()=>ctl.abort(), ms);
      try{
        const r = await fetch(url, { cache:"no-store", signal: ctl.signal });
        if(!r.ok) throw new Error("HTTP " + r.status);
        return await r.json();
      } finally {
        clearTimeout(t);
      }
    }

    async function loadRemote(){
      try{
        const data = await fetchJsonWithTimeout(WORKER_URL, 9000);
        const arr = Array.isArray(data.items) ? data.items : [];
        const cleaned = dedupe(arr.map(safeItem).filter(Boolean))
          .filter(x => (x.lang || "").toLowerCase().includes("pt"));
        remoteItems = cleaned.length ? cleaned : [];
      }catch(e){
        remoteItems = [];
      }
    }

    function rebuildPlaylist(){
      const local = shuffle(LOCAL_ITEMS.map(safeItem).filter(Boolean));
      const remote = shuffle(remoteItems.map(safeItem).filter(Boolean));

      playlist = (remote.length && local.length) ? interleave(remote, local) : (remote.length ? remote : local);

      if(!playlist.length){
        playlist = [safeItem({
          text:"Hidrate-se ao longo do dia.",
          source:"PontoView",
          sourceDomain:"pontoview",
          link:"https://www.gov.br/saude/pt-br",
          icon:"water_drop",
          lang:"pt-BR",
          category:"Hidratação",
          hint:"Dica prática: deixe uma garrafa à vista e água acessível."
        })];
      }

      idx = Math.floor(Math.random() * playlist.length);
    }

    /***********************
     * START
     ***********************/
    let resizeT = null;
    window.addEventListener("resize", ()=>{
      clearTimeout(resizeT);
      resizeT = setTimeout(()=>fitTitle(), 120);
    });

    (async ()=>{
      setOfflineOverlay();
      window.addEventListener("online", setOfflineOverlay);
      window.addEventListener("offline", setOfflineOverlay);
      setInterval(setOfflineOverlay, 5000);

      await loadRemote();
      rebuildPlaylist();

      render(playlist[idx++ % playlist.length]);

      rotStart = performance.now();
      requestAnimationFrame(animateProgress);

      setInterval(step, ROTATE_MS);
      setInterval(async ()=>{
        await loadRemote();
        rebuildPlaylist();
      }, 1000 * 60 * FETCH_EVERY_MIN);
    })();
  </script>
</body>
</html>
